<!DOCTYPE html><html lang="en-US"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>How to Deploy Airflow with Docker | Zend Wind's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="stylesheet" type="text/css" href="/css/copyright.css?v=0.0.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">How to Deploy Airflow with Docker</h1><a id="logo" href="/.">Zend Wind's Blog</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Start</i></a><a href="/archives/"><i class="fa fa-archive"> Archiv</i></a><a href="/about/"><i class="fa fa-user"> Über</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">How to Deploy Airflow with Docker</h1><div class="post-meta">Apr 4, 2020<span> | </span><span class="category"><a href="/categories/Docker/">Docker</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><p>This post introduces how to deploy Airflow with Docker.<br><a id="more"></a></p>
<h1 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h1><ul>
<li>CentOS7 (64-bit)</li>
<li>TencentCloud CVM (4C,8G)</li>
<li>Python3.6.0<h1 id="Docker-Install"><a href="#Docker-Install" class="headerlink" title="Docker Install"></a>Docker Install</h1><h2 id="Docker-Install-1"><a href="#Docker-Install-1" class="headerlink" title="Docker Install"></a>Docker Install</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum install -y docker   #in centos8, yum install -y docker-ce</div><div class="line">systemctl start docker</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Docker-Compose-Install"><a href="#Docker-Compose-Install" class="headerlink" title="Docker Compose Install"></a>Docker Compose Install</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"># download from github with curl</div><div class="line">curl -L https://github.com/docker/compose/releases/download/1.25.4/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose</div><div class="line">chmod +x /usr/local/bin/docker-compose</div><div class="line"></div><div class="line">#install python module</div><div class="line">pip install docker-compose</div><div class="line"></div><div class="line">#check docker-compose version</div><div class="line">docker-compose version</div></pre></td></tr></table></figure>
<h2 id="Airflow-Docker-Install"><a href="#Airflow-Docker-Install" class="headerlink" title="Airflow Docker Install"></a>Airflow Docker Install</h2><ul>
<li><p>Pull from Repository</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker pull puckel/docker-airflow</div></pre></td></tr></table></figure>
</li>
<li><p>Download Git Package</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git clone https://github.com/puckel/docker-airflow.git</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Airflow-LocalExecutor-Deploy"><a href="#Airflow-LocalExecutor-Deploy" class="headerlink" title="Airflow LocalExecutor Deploy"></a>Airflow LocalExecutor Deploy</h2><h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>The Airflow supports various deployment mode,  such as SequentialExecutor, LocalExecutor, CeleryExecutor, DaskExecutor, KubernetesExecutor.</p>
<ul>
<li>Airflow Local Executor Mode<br>Running Airflow on a LocalExecutor exemplifies single-node architecture. In dev or test environment, this mode is simple and easy for users to use Airflow.</li>
<li>Airflow CeleryExecutor Mode<br>Running Airflow on a CeleryExecutor exemplifies distributed architecture, and communicates with Celery. For production environment, this mode is popular for users to deploy.</li>
</ul>
<p>In this solution, only introduce how to deploy a LocalExecutor with docker.</p>
<h3 id="LocalExecutor-Deploy"><a href="#LocalExecutor-Deploy" class="headerlink" title="LocalExecutor Deploy"></a>LocalExecutor Deploy</h3><ul>
<li><p>Step 1. Modify airflow.cfg<br>Go into <code>docker-airflow/config</code> directory, open airflow.cfg and modify two items as below:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#specify executor type</div><div class="line">executor = LocalExecutor</div><div class="line"></div><div class="line">#specify postgresql data source</div><div class="line">sql_alchemy_conn = postgresql+psycopg2://airflow:airflow@postgres:5432/airflow</div></pre></td></tr></table></figure>
</li>
<li><p>Step2. Modify Dockerfile<br>The dockerfile in puckel image is based on Debian and includes all of steps how to build the airflow docker image. So it’s unnecessary for you to rebuild the whole image, the simplified dockerfile is as below, which only contains basic steps.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">FROM puckel/docker-airflow:latest</div><div class="line">#RUN pip install --user psycopg2-binary</div><div class="line">ARG AIRFLOW_USER_HOME=/usr/local/airflow</div><div class="line">USER root</div><div class="line">#RUN pip install  xxx</div><div class="line">ENV AIRFLOW_HOME=/usr/local/airflow</div><div class="line">COPY config/airflow.cfg /usr/local/airflow/airflow.cfg</div><div class="line"></div><div class="line">RUN chown -R airflow: $&#123;AIRFLOW_USER_HOME&#125;</div><div class="line"></div><div class="line">EXPOSE 8080 5555 8793</div><div class="line"></div><div class="line">USER airflow</div><div class="line">WORKDIR $&#123;AIRFLOW_USER_HOME&#125;</div><div class="line">ENTRYPOINT [&quot;/entrypoint.sh&quot;]</div><div class="line">CMD [&quot;webserver&quot;]</div></pre></td></tr></table></figure>
</li>
<li><p>Step3. Modify docker-compose-LocalExecutor.yml<br>This file includes the containers we need to deploy, such as postgres and webserver. Meanwhile, specify the <code>volumes</code> for container.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">version: &apos;3.7&apos;</div><div class="line">services:</div><div class="line">    postgres:</div><div class="line">        image: postgres:9.6</div><div class="line">        environment:</div><div class="line">            - POSTGRES_USER=airflow</div><div class="line">            - POSTGRES_PASSWORD=airflow</div><div class="line">            - POSTGRES_DB=airflow</div><div class="line">        ports:</div><div class="line">            - &quot;5432:5432&quot;</div><div class="line">        volumes:</div><div class="line">            - ./data/postgres:/var/lib/postgresql/data</div><div class="line">        logging:</div><div class="line">            options:</div><div class="line">                max-size: 10m</div><div class="line">                max-file: &quot;3&quot;</div><div class="line"></div><div class="line">    webserver:</div><div class="line">        image: puckel/docker-airflow:latest</div><div class="line">        restart: always</div><div class="line">        depends_on:</div><div class="line">            - postgres</div><div class="line">        environment:</div><div class="line">            - LOAD_EX=n</div><div class="line">            - EXECUTOR=Local</div><div class="line">        logging:</div><div class="line">            options:</div><div class="line">                max-size: 10m</div><div class="line">                max-file: &quot;3&quot;</div><div class="line">        volumes:</div><div class="line">            - ./dags:/usr/local/airflow/dags</div><div class="line">            # - ./plugins:/usr/local/airflow/plugins</div><div class="line">        ports:</div><div class="line">            - &quot;8080:8080&quot;</div><div class="line">        command: webserver</div><div class="line">        healthcheck:</div><div class="line">            test: [&quot;CMD-SHELL&quot;, &quot;[ -f /usr/local/airflow/airflow-webserver.pid ]&quot;]</div><div class="line">            interval: 30s</div><div class="line">            timeout: 30s</div><div class="line">            retries: 3</div></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>Note</strong>: the image version of webserver need change to <code>latest</code> version</p>
<ul>
<li><p>Step4. Rebuild image</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd puckel-docker-airflow</div><div class="line">docker build --rm -t puckel/docker-airflow .</div></pre></td></tr></table></figure>
</li>
<li><p>Step5. Deploy container</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd puckel-docker-airflow</div><div class="line">docker-compose -f docker-compose-LocalExecutor.yml up -d</div></pre></td></tr></table></figure>
</li>
</ul>
<p>Then you can execute <code>docker ps</code> to get the container list.<br>If you want to restart container, such as webserver, the command is as below:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">docker-compose -f ./docker-compose-LocalExecutor.yml stop webserver</div><div class="line">docker-compose -f ./docker-compose-LocalExecutor.yml start webserver</div></pre></td></tr></table></figure></p>
<ul>
<li>Step6. Deploy Dag<br>Add a dag file (Python) in <code>dags</code> directory which is defined as volumes of <code>webserver</code> container in docker-compose-LocalExecutor.yml. Then, you can find it on the Airflow website.<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://localhost:8080</div></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h1><ol>
<li><code>airflow initdb</code> error: airflow.exceptions.AirflowException: Could not create Fernet object: Incorrect padding<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">python -c &quot;from cryptography.fernet import Fernet;print(Fernet.generate_key().decode())&quot;</div><div class="line">3vWG_GoK_2MtU1fqRwCKrfNVsKW-ZcpdP8Ltz51xm64=</div><div class="line"></div><div class="line">export AIRFLOW__CORE__FERNET_KEY=3vWG_GoK_2MtU1fqRwCKrfNVsKW-ZcpdP8Ltz51xm64=</div></pre></td></tr></table></figure>
</li>
</ol>
</div><div class="article-footer-copyright">版权声明:本文由ballen原创，转载请注明出处, 本博客地址:zendwind.com</div><iframe src="/donate/?AliPayQR=null&amp;WeChatQR=/img/WeChatQR.png&amp;GitHub=null&amp;BTCQR=null&amp;BTCKEY=null&amp;PayPal=null" style="overflow-x:hidden;overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><div class="tags"><a href="/tags/Airflow/">Airflow</a></div><div class="post-nav"><a href="/2020/04/23/serverless-deploy-vuepress/" class="pre">How to Deploy Vuepress with Serverless Framework</a><a href="/2020/03/28/dynamodb-migrate-s3/" class="next">How to Migrate DynamoDB to Anonther Platform</a></div><div id="container"></div><link rel="stylesheet" href="/css/default.css?v=0.0.0"><script src="/js/gitment.browser.js?v=0.0.0"></script><script>var gitment = new Gitment({
  owner: 'zendwind## Your GitHub ID, e.g. username',
  repo: 'zendwind.github.io## The repository to store your comments, make sure you're the repo's owner, e.g. imsun.github.io',
  oauth: {
    client_id: 'e1067ce8b7aaa1a88a45## GitHub client ID, e.g. 75752dafe7907a897619',
    client_secret: '5f4e1d8d82c95a8610d5d19d51e97b7926fd5e71## GitHub client secret, e.g. ec2fb9054972c891289640354993b662f4cccc50',
  },
})
gitment.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="http://zendwind.com"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Kategorien</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/HBase/">HBase</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Serverless/">Serverless</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/TencentCloud/">TencentCloud</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/">hadoop</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/hadoop/" style="font-size: 15px;">hadoop</a> <a href="/tags/HBase/" style="font-size: 15px;">HBase</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/Airflow/" style="font-size: 15px;">Airflow</a> <a href="/tags/DynamoDB-COS/" style="font-size: 15px;">DynamoDB,COS</a> <a href="/tags/vuepress-serverless/" style="font-size: 15px;">vuepress,serverless</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Letzte</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/04/23/serverless-deploy-vuepress/">How to Deploy Vuepress with Serverless Framework</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/04/airflow-docker-install/">How to Deploy Airflow with Docker</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/28/dynamodb-migrate-s3/">How to Migrate DynamoDB to Anonther Platform</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/22/hbase-api/">An Introduction to HBase Native API</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/15/hadoop-small-file-storage/">【原】Hadoop小文件存储方案</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/11/phoenix-introduction/">【原】浅谈Phoenix在HBase中的应用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/15/python-read-dump/">【原】Python解析mysqldump文件</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/11/hbase-read-write-exception-summary/">【原】HBase读写异常问题总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/08/hdfs-multi-replicas-analysis/">揭开HDFS多副本的面纱</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/08/hadoop-ha-qjm/">【原】Hadoop HA机制学习</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Blogroll</i></div><ul></ul><a href="http://www.cnblogs.com/ballwql" title="cnblogs" target="_blank">cnblogs</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">Zend Wind's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>