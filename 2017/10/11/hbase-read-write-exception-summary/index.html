<!DOCTYPE html>
<html lang="zh-CN" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# object: http://ogp.me/ns/object# article: http://ogp.me/ns/article# profile: http://ogp.me/ns/profile#">
<head>
  <meta charset="utf-8">
  <title>【原】HBase读写异常问题总结</title>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="keywords" content="HBase,【原】HBase读写异常问题总结">
  <meta name="description" content="国庆期间，HBase集群出现一次比较严重的问题，故障期间，业务方反馈查询大量超时，由于涉及重点业务查询，影响也是比较大的。下面复盘一下问题发生过程并作相应分析">
   

  <meta name="og:type" content="article">
  <meta name="og:site_name" content="ZendWind's Blog and Project Site">
  <meta name="og:image" content="http://zendwind.com/image/logo.png">
  <meta name="og:title" content="【原】HBase读写异常问题总结">
  <meta name="og:url" content="http://zendwind.com/2017/10/11/hbase-read-write-exception-summary/">
  <meta name="og:description" content="国庆期间，HBase集群出现一次比较严重的问题，故障期间，业务方反馈查询大量超时，由于涉及重点业务查询，影响也是比较大的。下面复盘一下问题发生过程并作相应分析">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="ZendWind's Blog and Project Site">
  <meta name="twitter:image" content="http://zendwind.com/image/logo.png">
  <meta name="twitter:title" content="【原】HBase读写异常问题总结">
  <meta name="twitter:creator" content="@JamlingLi">
  <meta name="twitter:description" content="国庆期间，HBase集群出现一次比较严重的问题，故障期间，业务方反馈查询大量超时，由于涉及重点业务查询，影响也是比较大的。下面复盘一下问题发生过程并作相应分析">

  <!-- Canonical links -->
  <link rel="canonical" href="http://zendwind.com/2017/10/11/hbase-read-write-exception-summary/index.html">
  <!-- Alternative links -->
  <!-- CSS and JS-->
  <script src="//cdn.bootcss.com/jquery/2.2.0/jquery.min.js"></script>
<link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css">
<link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap-theme.min.css">
<script src="//cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<script src="//cdn.bootcss.com/sidr/2.2.1/jquery.sidr.min.js"></script>
<script src="/js/jquery.bootstrap-autohidingnavbar.min.js"></script>
<script src="/js/script.js"></script>
<script src="/js/lang_select.js"></script>
<link rel="stylesheet" href="//cdn.bootcss.com/sidr/2.2.1/stylesheets/jquery.sidr.dark.min.css">
<link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.15.10/styles/github.min.css">
<script src="//cdn.bootcss.com/highlight.js/9.15.10/highlight.min.js"></script>
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/tonsky/FiraCode@2/distr/fira_code.css">
<script src="//cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script>
<link rel="stylesheet" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css">
<link rel="stylesheet" href="//cdn.bootcss.com/fancybox/2.1.5/helpers/jquery.fancybox-buttons.css">
<script src="//cdn.bootcss.com/fancybox/2.1.5/helpers/jquery.fancybox-buttons.js"></script>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.2/animate.min.css">
<link rel="stylesheet" href="/css/nova_font.css">
<link rel="stylesheet" href="/css/bs/nova.css">

  <!-- RSS -->
  <link rel="alternate" href="/atom.xml" title="Zend Wind's Blog">
  <link rel="shortcut icon" href="/image/favicon.ico" type="image/x-icon" />
</head>
<body>
  <!-- header -->
  <header id="body-header">
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top">
    <div class="container container-fluid">
      <!-- Brand and toggle get grouped for better mobile display -->
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse_" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a href="/" id="logo"><img src="/image/logo.png" height="50" alt="logo"></a>
      </div>
      <!-- Collect the nav links, forms, and other content for toggling -->
      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav">
        <li><a href="/" class="main-nav">Home</a></li><li><a href="/p/" class="main-nav">Projects</a></li><li><a href="/categories/" class="main-nav">Category</a></li><li><a href="/archives/" class="main-nav">Archive</a></li><li><a href="/donate/" class="main-nav">Donate</a></li><li><a href="/about/" class="main-nav">About</a></li>
        </ul>
        <!-- search input -->
        

<!-- 百度站内搜索（已通过站点验证） -->
<form class="navbar-form navbar-left" role="search"
  action="//search.zendwind.com/cse/search">
  <div class="form-group search">
    <input type="text" name="q" id="bdcsMain" class="form-control primary" aria-label="..." placeholder="Search">
    <input type="hidden" name="s" value="11812712506721118476">
    <input type="hidden" name="nsid" value="0">
    <!-- 
    <input name="tn" type="hidden" value="SE_zzsearchcode_shhzc78w">
    <input name="cl" type="hidden" value="3">
    <input name="ct" type="hidden" value="2097152">
    <input name="si" type="hidden" value="ieclipse.cn">
    <input name="ie" type="hidden" value="utf-8">
    -->
  </div>
</form>

        <ul class="nav navbar-nav navbar-right">
        </ul>
      </div>
    </div>
  </nav>
</header>

  <!-- main -->
  
<div class="container container-fluid">
<div class="row">
  <div class="col-sx-12 col-sm-8 col-md-9 col-lg-9">
    
<article class="article post" itemscope="itemscope" itemtype="http://schema.org/Article">
  <header class="article-header">
    <div class="page-path"><span class="post-category"><span class="glyphicon glyphicon-folder-close" aria-hidden="true"></span>Path: <a class="category-item" href="/">Blog</a><a class="category-item" href="/categories/HBase/">HBase</a></span></div>
    <div class="divider"></div>
      <h1 class="article-title" itemprop="name headline"></h1>
    <div class="post-header clearfix">
      <span class="post-date"><span class="hidden-xs icon nova-calendar">Post at: </span>
      <time datetime="2017-10-11T01:26:00.000Z" itemprop="datePublished"><time datetime="2017-10-11T01:26:00.000Z">2017-10-11</time></time>
      </span>
      
      <span class="post-share">
        <a href="#share" class="icon nova-share"><span class="hidden-xs">Share</span><span class="jiathis_counter_style"></span></a>
        <a href="#comment" class="icon nova-bubbles"><span class="ds-thread-count" id="changyan_count_unit" data-thread-key="d5fabf21998c8c696fcbc467b7a8f36c"></span><span class="hidden-xs">Comment</span></a>
        <!--<a href="#like" class="icon nova-heart2-full"><span class="count" id="changyan_parti_unit"></span><span class="hidden-xs">Like</span></a>-->
        <a href="#" class="icon nova-eye"><span class="count lc-count"></span><span class="hidden-xs">Views</span></a>
      </span>
    </div>
    <div class="divider"></div>
    <meta content="2017-10-11T01:26:00.000Z" itemprop="datePublished">
  </header>
  <div class="article-content" itemprop="articleBody">
  
    <p>国庆期间，HBase集群出现一次比较严重的问题，故障期间，业务方反馈查询大量超时，由于涉及重点业务查询，影响也是比较大的。下面复盘一下问题发生过程并作相应分析<br><a id="more"></a></p>
<h1 id="一、问题描述"><a href="#一、问题描述" class="headerlink" title="一、问题描述"></a>一、问题描述</h1><p>10月6号傍晚从18:00点开始，业务陆续反馈查询HBase历史数据异常，出现大量超时，下面是当时的业务成功率曲线。整个过程经历了5次成功率下降的阶段，这是之前未出现过的。<br><img src="/2017/10/11/hbase-read-write-exception-summary/business_success_rate.png" alt="图1. 业务成功率曲线"></p>
<p>在查看重点业务组所在机器的写监控曲线，故障期间重点表基本不可写：<br><img src="/2017/10/11/hbase-read-write-exception-summary/hbase_write_request.png" alt="图2.重点表写曲线"></p>
<p>同时重点表的读也是异常的，基本不可读：<br><img src="/2017/10/11/hbase-read-write-exception-summary/hbase_read_request.png" alt="图3.重点表读曲线"></p>
<h1 id="二、原因分析"><a href="#二、原因分析" class="headerlink" title="二、原因分析"></a>二、原因分析</h1><h2 id="2-1-采集分析"><a href="#2-1-采集分析" class="headerlink" title="2.1 采集分析"></a>2.1 采集分析</h2><p>查看数据采集曲线，未看到有表数据发生延迟采集或DB数据源故障情况，排除采集异常。</p>
<h2 id="2-2-消费分析"><a href="#2-2-消费分析" class="headerlink" title="2.2 消费分析"></a>2.2 消费分析</h2><p>查看数据消费曲线，发现重点业务的所有表消费曲线延迟严重，消费者本身无报错产生，查看消费日志写得很慢，既然消费未报错又写得慢，问题应该出现在HBase端。</p>
<h2 id="2-3-HBase分析"><a href="#2-3-HBase分析" class="headerlink" title="2.3 HBase分析"></a>2.3 HBase分析</h2><h3 id="2-3-1-第一次-amp-第二次异常原因分析"><a href="#2-3-1-第一次-amp-第二次异常原因分析" class="headerlink" title="2.3.1 第一次&amp;第二次异常原因分析"></a>2.3.1 第一次&amp;第二次异常原因分析</h3><p>根据经验，HBase读写异常很大程度上和机器异常有关。首先，找出重点业务所在的机器列表，并根据所采集的监控曲线，看了下这些机器的处理时耗，如下图所示：<br><img src="/2017/10/11/hbase-read-write-exception-summary/machine_queue_process_time.png" alt="图4.机器处理时耗"><br>从图中，可看出在故障期间，这些机器的处理时耗异常，是所有机器都异常还是只有个别机器处理异常呢，继续从上面图查看分布状态图，如下图所示：<br><img src="/2017/10/11/hbase-read-write-exception-summary/machine_queue_process_time_ip.png" alt="图5.单机处理时耗"><br>从图可以看出，确实有一台机器的处理时耗比其它机器都高，找到异常机器后，从tnm2上看了下单机性能情况，如下图所示：<br><img src="/2017/10/11/hbase-read-write-exception-summary/machine_performance.png" alt="图6.单机性能曲线"><br>从图中，可以看出，异常机器在18:00附近各项指标也是异常的，磁盘IO、CPU负载、SWAP内存都表现异常，说明机器确实存在问题。那是什么原因导致的机器负载异常呢，继续登陆机器查看日志情况，在18:00附近左右，找到如下一个异常：<br><img src="/2017/10/11/hbase-read-write-exception-summary/machine_hbase_log.png" alt="图7.异常机器日志异常"><br>从多个异常描述中，都发现一个共性现象，就是集中在t_tcbankroll_list_auid_201707这个表上，看日志信息是这个表在作合并，查看了下合并任务，发现确实在这天有一条合并定时任务，合并任务主要是合并3个月前的表，正好是上述7月份的表，是不是合并存在异常呢，继续看了下监控中关于该异常IP的合并队列,发现在18:00合并队列高达59000，即有几万个合并任务等着被执行，之后合并队列表现异常，机器读写也异常，说明确实合并有问题。<br><img src="/2017/10/11/hbase-read-write-exception-summary/machine_compact_queue.png" alt="图8.异常机器合并队列"><br>为什么合并会有问题呢？进一步看了下异常表的region的大小，发现大小严重不均，集中在两个端，8G和20G左右。合并出问题应该是出在合并20G大小的region时出现的问题。<br><img src="/2017/10/11/hbase-read-write-exception-summary/hbase_table_region.png" alt="图9.异常表region文件数"><br>是在合并哪个Region的时候出的问题呢，再看下图7中异常机器的日志，发现<code>324c091cfd8e944507ae645ddeda78e2</code>这个region合并时出的问题，同时这个region的大小在图9中正好属于20G那个范围的，验证了上述猜想。<br>那为什么合并大Region过程出现问题了呢，再从18:00异常时间点附近看了下日志，如下所示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">2017-10-06 18:22:36,280 WARN  [regionserver60020] util.Sleeper: We slept 24555ms instead of 3000ms, this is likely due to a long garbage collecting pause and it&apos;s usually bad, see，http://hbase.apache.org/book.html#trouble.rs.runtime.zkexpired</div><div class="line">2017-10-06 18:22:36,280 WARN  [JvmPauseMonitor] util.JvmPauseMonitor: Detected pause in JVM or host machine (eg GC): pause of approximately 22680ms</div><div class="line">GC pool &apos;ParNew&apos; had collection(s): count=1 time=247ms</div><div class="line">GC pool &apos;ConcurrentMarkSweep&apos; had collection(s): count=1 time=22712ms</div></pre></td></tr></table></figure>
<p>这种迹象很明显就是在作FullGC，频繁的GC过程阻塞了读写进程， 在这个时间段内，看了下JVM堆内存的使用量，发现异常的高，如下所示：<br><img src="/2017/10/11/hbase-read-write-exception-summary/machine_jvm.png" alt="图10.异常机器JVM堆内存使用"><br>了解FullGC的人都知道，FullGC期间，集群读写会被堵塞，如图7所示客户端连接会出现超时异常，再加上我们机器本身性能比较差，导致FullGC过程中，机器IO、网络、CPU、内存和SWAP等都出现异常，阻塞了集群读写，影响了重点业务的查询。知道啥原因后，直接把机器剔除停掉regionserver进程，业务读写开始恢复正常。</p>
<p>好景不长，只过了不到20min, 第二次异常突然降临，在18点56时，业务查询成功率又开始降低。回想一下第一次故障，只是把当时有异常的机器剔除，但没考虑的是异常表的合并任务并未终结，只是把合并异常的任务转移到其它机器，重点业务组机器并未终止合并，即其它机器的负载并未得到有效缓解，看监控曲线发现，此时另一台机器出现异常，如图10所示，该机集群处理时耗明显高于其它机器，和第一次样，把异常机器剔除后业务恢复正常。<br><img src="/2017/10/11/hbase-read-write-exception-summary/machine_process_time.png" alt="图11.异常机器时耗曲线"></p>
<h3 id="2-3-2-第三次-amp-第四次-amp-第五次故障分析"><a href="#2-3-2-第三次-amp-第四次-amp-第五次故障分析" class="headerlink" title="2.3.2 第三次&amp;第四次&amp;第五次故障分析"></a>2.3.2 第三次&amp;第四次&amp;第五次故障分析</h3><p>前面2次的故障还好，都还是单机异常所致，后面出现的两次异常却是多机同时出现异常，此时单纯剔除单台机器已无法解决问题，因重点业务组所在机器数量比较少，再重新扩机器进去也不太可行，如果都剔除那读写就完全中止了，影响更大。<br>上面说到，其实前两次故障都没解决合并异常的本质问题，合并还在继续，合并队列也维持在一个高位，此时对整个机器组来说压力都是非常大的，机器资源大量被用于作合并，导致其它操作无法有效获取资源。只能想其它办法解决。<br>既然合并队列一直在高位，有什么办法可以降低合并队列长度呢，社区<code>HBase-17928</code>补丁给我们带来了福音，它要解决的就是当表合并异常或在很长时间合并都未完成的场景。使用方式如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">clear_queues &apos;SERVERNAME&apos;, [&apos;QUEUE_NAME1&apos;,&apos;QUEUE_NAME2&apos;]</div></pre></td></tr></table></figure></p>
<p>其中，SERVERNAME表示regionserver，形式如<code>ip,port,timestamp</code>，QUEUE_NAME表示队列的长度，可以为<code>short,long</code>。对于我们来说，采用的是直接清理到机器的合并队列，即如果机器10.x.x.x有问题，清理如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">clear_queues &apos;10.x.x.x,60020,1491511804929&apos;</div></pre></td></tr></table></figure></p>
<p>在清理部分合并队列过长的机器之后，集群读写恢复了部分，但还未全部恢复，导致了第四次业务查询还是受影响，因为清理时没把所有机器清理干净，所以异常还未完全解决。<br>第四次故障之后，对剩下的机器也全部清理了一遍队列，同时还作了一个操作，就是<strong>把异常表移出重点业务组，让合并在组外的机器进行</strong>，这样能尽量避免异常表对其它表影响。</p>
<p>在做完上述动作之后，隔了不到10min, 第5次故障又如期而至，充分验证了墨菲定律，不想发生的偏要发生。第5次故障是什么原因呢，从监控曲线上面看，根据第一次和第二次的故障分析，总结出此次也是因单机故障引起的，首先做的就是剔除该异常机器，但因负载问题，一直登录异常，耽误了异常恢复原因，等剔除后业务终于开始恢复正常。</p>
<p>在观察一段时间后，整个重点业务组暂时运行稳定，此时因踢掉了多台机器，组内的10几台机器的region已经分布不均，有潜在风险，需要考虑把之前剔除机器上的region还原。正常的还原方法是，如果regionserver剔除是按正规流程剔除的话，会记录该机器上有什么region，然后机器恢复后把region再move回来即可；不过，像我们这种情况，属于紧急剔除，踢之前没考虑记录region信息，需要考虑从其它渠道来恢复信息，还有一种方法是从日志恢复，日志恢复方法就是从master上去找剔除时间点开始往后带关键字如<code>Transition和Offline</code>等关键字的日志，然后找出region move回到原机器即可。</p>
<h1 id="三、故障梳理"><a href="#三、故障梳理" class="headerlink" title="三、故障梳理"></a>三、故障梳理</h1><p>经过上述一系列的分析和采取的一系列措施，故障得以恢复，整个故障原因总结如下：</p>
<blockquote>
<ul>
<li>合并任务异常，触发机器频繁GC，机器负载异常</li>
<li>GC阻塞了DFSClient的读写请求发送</li>
<li>HDFS服务端报大量的读写Socket连接超时并关闭client请求连接</li>
</ul>
</blockquote>
<p>故障措施总结：</p>
<blockquote>
<ul>
<li>剔除异常机器regionserver进程</li>
<li>清理异常机器的合并队列</li>
<li>恢复region回原机器</li>
</ul>
</blockquote>
<h1 id="四、故障反思"><a href="#四、故障反思" class="headerlink" title="四、故障反思"></a>四、故障反思</h1><p>此次故障引发的连锁反应之前也没遇到过，耽误了很多时间，也侧面反应出自己对这些异常缺乏足够的认识，通过此次排查也让自己对regionserver异常有一个更清楚的了解，后续在运维过程中需要更多关注以下一些点：</p>
<blockquote>
<ul>
<li>出现异常，以业务恢复为先，先保留事故现场日志，该剔除的剔除</li>
<li>监控完善，一直在说监控问题，但监控事项总有些纰漏，需在这块优化加强，尤其是巡检机制</li>
<li>业务重点表隔离细化，虽然已经做了相应隔离，但分级还是不够细化，需针对重点业务再作分级隔离</li>
</ul>
</blockquote>

  
  </div>

  <script src="/js/decrypt.min.js"></script>
  <footer class="article-footer">
    <time class="article-footer-updated" datetime="2020-04-24T02:51:25.984Z" itemprop="dateModified">
    Last updated: 2020-04-24
    </time>
    <span itemprop="author publisher" itemscope="itemscope" itemtype="http://schema.org/Organization">
      <meta content="http://zendwind.com" itemprop="url">
      <meta content="ZendWind's Blog and Project Site" itemprop="name">
      <meta content="/image/logo.png" itemprop="logo">
    </span>
    
<a id="share"></a>
<div class="social-share"></div>
<script>
with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js'];
</script>


  </footer>
</article>

<div class="page-footer">
  <nav><ul class="pager"><li class="previous"><a href="/2017/10/15/python-read-dump/"><span aria-hidden="true">&larr;</span><span class="hidden-xs">Prev</span></a></li><li class="next"><a href="/2017/10/08/hadoop-ha-qjm/"><span aria-hidden="true">&rarr;</span><span class="hidden-xs">Next</span></a></li></ul></nav>
  
<!-- Button trigger modal -->
<blockquote class="donate"><!--
  <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#DonateModal">
    Donate
  </button>-->
  <p>
  <a href="#" role="button" data-toggle="modal" data-target="#DonateModal">
  <img src="/image/donate_button.png" alt="donate">
  <span>Dear reader, if you feel this good, could you rewark me a `bread` as awark? Thank you very much~</span></a>
  </p>
</blockquote>
<!-- Modal -->
<div class="modal fade" id="DonateModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <span class="modal-title" id="myModalLabel">Donate</span>
      </div>
      <div class="modal-body"><!--
        <table>
        <thead>
          <th class="text-center">支付宝</th>
          <th class="text-center">微信支付</th>
        </thead>
        <tr>
          <td><img src="/image/donate_alipay.png" alt="使用支付宝扫码打赏" class="img-rounded donate" width="200" height="200"></td>
          <td><img src="/image/donate_wechat.png" alt="使用微信扫码打赏" class="img-rounded donate" width="200" height="200"></td>
        </tr>
        </table>-->
        <div class="container-fluid">
        <div class="row">
        <div class="col-md-6">
          <div class="text-center">
            <span style="display:block;">支付宝</span>
            <img src="/image/donate_alipay.png" alt="使用支付宝扫码打赏" class="donate" />
          </div>
        </div>
        <div class="col-md-6">
          <div class="text-center">
            <span style="display:block;">微信支付</span>
            <img src="/image/donate_wechat.png" alt="使用微信扫码打赏" class="donate" />
          </div>
        </div>
        </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

  <a id="comment"></a>

<script src="//unpkg.com/valine/dist/Valine.min.js">
</script>
<!--PC和WAP自适应版-->
<div id="vcomments" data-sid="d5fabf21998c8c696fcbc467b7a8f36c" ></div>
<script>
    new Valine({
        el: '#vcomments',
        appId: 's7YiMwoKljbjEyiPSekMYxHW-gzGzoHsz',
        appKey: 'QdFr23RGUj3JYo0I4Yi8wuV3',
        path: 'd5fabf21998c8c696fcbc467b7a8f36c',
        recordIP: true
    })
</script>



</div>


    
  </div> <!-- end main column  -->
  <!-- aside -->
  <div class="col-sx-12 col-sm-4 col-md-3 col-lg-3">
    <aside>
      <div id="navbar-toc">
      <nav id="toc" class="hidden-print hidden-xs hidden-sm" data-spy="affix">
        <div class="toc-title"><a role="button" data-toggle="collapse" href="#toc-body" aria-expanded="true">
          Table Of Contents
        </a></div>
        <div id="toc-body" class="in">
        <ul class="nav toc-ul"><li><a href="#一、问题描述">一、问题描述</a></li><li><a href="#二、原因分析">二、原因分析</a><ul class="nav toc-ul"><li><a href="#2-1-采集分析">2.1 采集分析</a></li><li><a href="#2-2-消费分析">2.2 消费分析</a></li><li><a href="#2-3-HBase分析">2.3 HBase分析</a><ul class="nav toc-ul"><li><a href="#2-3-1-第一次-amp-第二次异常原因分析">2.3.1 第一次&第二次异常原因分析</a></li><li><a href="#2-3-2-第三次-amp-第四次-amp-第五次故障分析">2.3.2 第三次&第四次&第五次故障分析</a></li></ul></li></ul></li><li><a href="#三、故障梳理">三、故障梳理</a></li><li><a href="#四、故障反思">四、故障反思</a></li></ul>
        </div>
      </nav>
</div>

      
    </aside>
  </div> <!-- end aside column  -->
</div> <!-- end row -->
</div> <!-- end container -->

  <!-- footer -->
  <footer id="body-footer">
  <div class="divider"></div>
  <div>&nbsp;</div>
  <div class="inner text-center">
    <div id="footer-copyright">
      &copy; 2020 <a href="http://zendwind.com" target="_blank">Wen Qiuliang</a> powered by <a href="http://hexo.io" target="_blank">Hexo</a> Theme <a href="https://github.com/Jamling/hexo-theme-nova" target="_blank">Nova</a><br>
      <!-- Documentation licensed under <a href="http://creativecommons.org/licenses/by/4.0/" target="_blank">CC BY 4.0</a>. -->
    </div>
    <div>
      <a href="http://www.beian.miit.gov.cn" target="_blank"></a>
    </div>
  </div>
</footer>

  <!-- fixed action bar -->
  
  <div class="fab hidden-print" style="bottom: 45px; right: 24px;">
  <!--
    <ul class="top-expand" id="top-expand">
      <li><a class="fab-item large red" href="#top"><i class="icon nova-top"></i></a></li>
      <li><a class="fab-item large yellow " href="//www.jiathis.com/share?uid=2064663" target="_blank"><i class="icon nova-share"></i></a></li>
    </ul>
    <a class="fab-item large red " onclick="$('#top-expand').toggle();">
      <i class="icon nova-list-ul"></i>
    </a>
    -->
    <a class="fab-item large red " href="#top">
      <i class="icon nova-top"></i>
    </a>
  </div>

  <!-- after footer, some 3rd script place here -->
    <script>
    var hljs_labels = {
        left: "Code",
        right: ":",
        copy: "Copy to clipboard"
    }
    </script>
    <script src="/js/hljs.js"></script>
    <script src="/js/script.js"></script>
    
    <!-- 安装自动推送JS代码的网页，在页面被访问时，页面URL将立即被推送给百度 -->
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

    <!-- 新建的搜索框代码，建立使用你自己的代码替换-->
<script>
(function(){document.write(unescape('%3Cdiv id="bdcs"%3E%3C/div%3E'));var bdcs = document.createElement('script');bdcs.type = 'text/javascript';bdcs.async = true;bdcs.src = 'http://znsv.baidu.com/customer_search/api/js?sid=11812712506721118476' + '&plate_url=' + encodeURIComponent(window.location.href) + '&t=' + Math.ceil(new Date()/3600000);var s = document.getElementsByTagName('script')[0];s.parentNode.insertBefore(bdcs, s);})();
</script>

    

<!-- LeanClound官方Javascript SDK -->
<script>
  var page_layout = 'false'
  var lc_debug = false;
  if(typeof AV === 'undefined') {
    $.getScript('//cdn1.lncld.net/static/js/av-min-1.2.1.js',function() {
      lc_debug && console.log('init AV after av.js loaded');
        AV.init({
          appId : 's7YiMwoKljbjEyiPSekMYxHW-gzGzoHsz',
          appKey : 'QdFr23RGUj3JYo0I4Yi8wuV3'
        });
        if (page_layout === 'true') {
          lc_index_views('.card-action', {
            style : 'hidden-xs',
            p : {
              views : '.nova-eye .count'
            }
          })
        }
        lc_page_views();
    });
  }

  var lc_config = {
    pageId : 'd5fabf21998c8c696fcbc467b7a8f36c',
    url : '2017/10/11/hbase-read-write-exception-summary/' || 'http://zendwind.com/2017/10/11/hbase-read-write-exception-summary/',
    title : '【原】HBase读写异常问题总结'
  };
  lc_debug && console.log('lcconfig', lc_config);

  var lc_table = 'Counter' || 'Counter';

  function lc_page_views() {
    var query = new AV.Query(lc_table);
    query.select(['-ACL']);
    query.equalTo('pageId', lc_config.pageId);
    query.first({
      success: function(results) {
        // results is an array of AV.Object.
        if (typeof results === 'undefined') {
          insert(results);
          return;
        }
        update(results);
        show(results);
      },
      error: function(error) {
        // error is an instance of AV.Error.
        console.log(error);
      }
    });

    function insert(data) {
      if (!data) {
        lc_debug && console.log('data is null new object');
        var M = AV.Object.extend(lc_table);
        data = new M();
        data.set('views', 1);
      }
      for ( var key in lc_config) {
        data.set(key, lc_config[key]);
      }
      data.save().then(function(data) {
        lc_debug && console.log('created objectId is ' + data.id);
      }, function(error) {
        lc_debug && console.log("create object failed", error);
      });
    }

    function update(data) {
      for ( var key in lc_config) {
        if (key !== 'pageId')
        data.set(key, lc_config[key]);
      }
      lc_debug && console.log("after change,data", data);
      data.increment('views', 1);
      data.save().then(function(data) {
        lc_debug && console.log("update to " + data.get('views'));
      }, function(error) {
        lc_debug && console.log("update object failed", error);
      });
    }

    function show(data) {
      $(".lc-count").html(data.get('views'));
    }
    function show_count(count) {
      $(".lc-count").html(count);
    }
  };

  function lc_index_views() {
    // load views count from leanclound
    // make sure you are created Counter table on leanclound
    function lc_load_views(selector, options) {
      var o = options || {};
      var tkeys = [];
      $(selector).each(function(i) {
        var tkey = $(this).data('tkey');
        tkeys.push(tkey);
      });

      var query = new AV.Query(lc_table);
      query.select([ '-ACL', '-createdAt', '-updatedAt', '-url' ]);
      query.containedIn('pageId', tkeys);
      query.find().then(function(results) {
        $(selector).each(function(i) {
          var tkey = $(this).data('tkey');
          for (var i = 0; i < results.length; i++) {
            var t = results[i];
            if (t.get('pageId') === tkey) {
              var c = t.get('views') + '';
              $(this).find(o.p.views).html(c);
            }
          }
        });
      }, function(error) {
      });
    }

    lc_load_views('.card-action', {
      style : 'hidden-xs',
      p : {
        views : '.nova-eye .count'
      }
    });
  }
</script>

</body>
</html>
