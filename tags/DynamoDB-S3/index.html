<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>Tag: DynamoDB, S3 - Zend Wind&#39;s Blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">


<link href="/zh-cn/tags/DynamoDB-S3/index.html" rel="alternate" hreflang="zh-CN" />
    






    <meta property="og:type" content="website">
<meta property="og:title" content="Zend Wind&#39;s Blog">
<meta property="og:url" content="http://zendwind.com/tags/DynamoDB-S3/index.html">
<meta property="og:site_name" content="Zend Wind&#39;s Blog">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Zend Wind&#39;s Blog">





<link rel="icon" href="/favicon.png">



<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/css/justifiedGallery.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">

<link rel="stylesheet" href="/css/style.css">

<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>


    
    
    
    
    
    
    
    
    
    

    



  <script async="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


</head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                <img src="/images/logo.png" alt="" height="28">
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/archives">Archives</a>
            
            <a class="navbar-item "
               href="/categories">Categories</a>
            
            <a class="navbar-item "
               href="/tags">Tags</a>
            
            <a class="navbar-item "
               href="/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="Search" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            
            <a class="navbar-item" title="GitHub" href="https://github.com/zendwind">
                
                <i class="fab fa-github"></i>
                
            </a>
               
            
       
            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true" aria-controls="dropdown-menu7">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>English</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            
                <a href="/tags/DynamoDB-S3/index.html" class="dropdown-item">
                    English
                </a>
            
                <a href="/zh-cn/tags/DynamoDB-S3/index.html" class="dropdown-item">
                    简体中文
                </a>
            
            </div>
        </div>
    </div>
</div>


        </div>
    </div>
   

</nav>

    <section class="section section-heading">
    <div class="container">
        <div class="content">
            <h5>#DynamoDB, S3</h5>
        </div>
    </div>
</section>
<section class="section">
    <div class="container">
    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="/2020/04/28/dynamodb-export-with-pipeline/" itemprop="url">Export DynamoDB to S3 with AWS Data Pipeline</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time class="is-text-small" datetime="2020-04-28T03:00:00.000Z" itemprop="datePublished">
                        Apr 28 2020</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/AWS/">AWS</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            14 minutes read
        </span>
        
        
        <span class="column is-narrow" id="busuanzi_value_page_pv">0</span>
        <span class="column is-narror"> PageView</span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h1 id="1-Preface"><a href="#1-Preface" class="headerlink" title="1. Preface"></a>1. Preface</h1><p>This section presents how to migrate full data from DynamoDB (AWS) to TcaplusDB (TencentCloud). All scripts are written in <code>Python3.6</code> environment.</p>
<h1 id="2-Resources"><a href="#2-Resources" class="headerlink" title="2. Resources"></a>2. Resources</h1><h2 id="2-1-AWS-Resources"><a href="#2-1-AWS-Resources" class="headerlink" title="2.1 AWS Resources"></a>2.1 AWS Resources</h2><p>The below components will be used in this section.</p>
<ul>
<li><strong>Aamazon DynamoDB</strong></li>
<li><strong>AWS Data Pipeline</strong></li>
<li><strong>AWS S3</strong><h2 id="2-2-Tencent-Cloud-Resources"><a href="#2-2-Tencent-Cloud-Resources" class="headerlink" title="2.2 Tencent Cloud Resources"></a>2.2 Tencent Cloud Resources</h2>The below components will be used in this section.</li>
<li><strong>Tcaplus Database</strong></li>
<li><strong>CVM</strong></li>
<li><strong>EMR</strong></li>
<li><strong>COS</strong></li>
</ul>
<h1 id="3-Prerequisites"><a href="#3-Prerequisites" class="headerlink" title="3. Prerequisites"></a>3. Prerequisites</h1><h2 id="3-1-TencentCloud-CVM-Environment"><a href="#3-1-TencentCloud-CVM-Environment" class="headerlink" title="3.1 TencentCloud CVM Environment"></a>3.1 TencentCloud CVM Environment</h2><ul>
<li><ol>
<li>Apply for a TencentCloud CVM instance in related region.</li>
</ol>
</li>
<li><ol>
<li>Check openssl-devel  is exist or not, the <code>boto3</code> module depends on the <code>ssl</code> module.<pre><code>yum install -y openssl-devel
</code></pre></li>
</ol>
</li>
<li><ol>
<li>Check <code>pip</code> is exist or not<pre><code>yum install -y python-pip
</code></pre><h2 id="3-2-Python-Installation"><a href="#3-2-Python-Installation" class="headerlink" title="3.2 Python Installation"></a>3.2 Python Installation</h2>The whole execution environment will be in <code>Python 3.6.</code></li>
</ol>
</li>
<li><ol>
<li><p>Download Python3.6 from <a href="https://www.python.org/downloads/release/python-360/" target="_blank" rel="external">Official Website</a>, and upload Python3.6 package to CVM instance, and uncompress it, such as <code>/root/Python3.6.0</code>. Then compile it with below command:</p>
<pre><code>#compile
./configure --enable-shared --prefix=/data/python3.6
make &amp;&amp; make install

#load library, add python3.6 library into /etc/ld.so.conf
echo &quot;/data/python3.6/lib&quot; &gt;&gt;/etc/ld.so.conf

#load config
ldconfig
</code></pre></li>
</ol>
</li>
<li><ol>
<li><p>Use <code>virtualenv</code> to manage the multi-version of Python</p>
<pre><code>#install
pip install virtualenv

#define env
mkdir /root/pyenv

cd /root/pyenv

virtualenv --python /usr/bin/python py2env
virtualenv --python /data/python3.6/bin/python3 py3env

#make alias in /root/.bashrc
alias  py3env=&apos;source /root/pyenv/py3env/bin/activate&apos;
alias  py2env=&apos;source /root/pyenv/py2env/bin/activate&apos;

#make it work
source ~/.bashrc
</code></pre><p>As you operate as the above steps, you can use <code>py3env</code> or <code>py2env</code> to activate the related Python version.</p>
</li>
</ol>
</li>
</ul>
<h2 id="3-3-Python-Modules-Install"><a href="#3-3-Python-Modules-Install" class="headerlink" title="3.3 Python Modules Install"></a>3.3 Python Modules Install</h2><p>Login the CVM instance, and install Python modules with pip in Python3 environment, including <code>awscli(&gt;=1.18.15), boto3 &gt;=(1.7.45), Faker(&gt;=0.8.16) , coscmd (latest) and cos-python-sdk-v5 (latest)</code>.</p>
<pre><code>pip install awscli==1.18.15
pip install boto3==1.7.45
pip install Faker==0.8.16
pip install coscmd==1.8.6.14
pip install cos-python-sdk-v5
</code></pre><h2 id="3-4-AWS-Credentials-Config"><a href="#3-4-AWS-Credentials-Config" class="headerlink" title="3.4 AWS Credentials Config"></a>3.4 AWS Credentials Config</h2><p> Configure aws cli in <code>CVM</code> environment, see <a href="https://docs.aws.amazon.com/opsworks/latest/userguide/registered-instances-register-registering-cli.html" target="_blank" rel="external">official website</a></p>
<ul>
<li><ol>
<li><p>In command line, create an <code>.aws</code> directory under /root directory and touch a <code>credentials</code> file, then replace aws_access_key_id and aws_secret_access_key of your aws account</p>
<pre><code>[default]
aws_access_key_id=xxx
aws_secret_access_key=xxx
</code></pre></li>
</ol>
</li>
<li><ol>
<li>Set up region info in <code>config</code> file under <code>.aws</code> directory<pre><code>[default]
region = xxx
</code></pre></li>
</ol>
</li>
</ul>
<h2 id="3-5-Tencent-Cloud-COS-Credentials-Config"><a href="#3-5-Tencent-Cloud-COS-Credentials-Config" class="headerlink" title="3.5 Tencent Cloud COS Credentials Config"></a>3.5 Tencent Cloud COS Credentials Config</h2><p>Configure cos cli in <code>CVM</code> environment, see <a href="https://intl.cloud.tencent.com/document/product/436/10976" target="_blank" rel="external">COSCMD Documentation</a>.<br>Create a new file <code>.cos.conf</code> under <code>/root</code> directory, and add below contents in file:</p>
<pre><code>[common]
secret_id = XXX
secret_key = XXX
bucket = examplebucket-1250000000
region = ap-shanghai
max_thread = 5
part_size = 1
scheme = https
</code></pre><h2 id="3-6-Data-Type-Comparison"><a href="#3-6-Data-Type-Comparison" class="headerlink" title="3.6 Data Type Comparison"></a>3.6 Data Type Comparison</h2><p>The data types between DynamoDB and TcaplusDB are different, see as below:<br>|Amazon DynamoDB|TcaplusDB|<br>|&#x2014;|&#x2014;|<br>|Number| int32,uint32,int64,uint64,sint64, double,float|<br>|String|string|<br>|Boolean|bool|<br>|Binary|bytes|<br>|Sets|Array|<br>|List|Array|<br>|Map|struct|</p>
<h2 id="3-7-Primary-Key"><a href="#3-7-Primary-Key" class="headerlink" title="3.7 Primary Key"></a>3.7 Primary Key</h2><p>In DynamoDB, the primary key has two formats:</p>
<ul>
<li>partition key and range key</li>
<li>partition key only<br>In TcaplusDB, the primary key includes one or more attributes(less than 4).</li>
</ul>
<p>In this section, the primary key in TcaplusDB is the same as DynamoDB, including one paritition attribute and one range attribute. Meanwhile, design an index of partition key.</p>
<h2 id="3-8-Table-Sample"><a href="#3-8-Table-Sample" class="headerlink" title="3.8 Table Sample"></a>3.8 Table Sample</h2><table>
<thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Note</th>
</tr>
</thead>
<tbody>
<tr>
<td>Username</td>
<td>String</td>
<td>primary key</td>
</tr>
<tr>
<td>PointsEarned</td>
<td>int64</td>
<td></td>
</tr>
<tr>
<td>ReminderDate</td>
<td>String</td>
<td></td>
</tr>
<tr>
<td>Subscribed</td>
<td>Bool</td>
<td></td>
</tr>
<tr>
<td>Zipcode</td>
<td>int64</td>
<td></td>
</tr>
<tr>
<td>UserInfo</td>
<td>String</td>
</tr>
</tbody>
</table>
<h1 id="4-DynamoDB-Environment"><a href="#4-DynamoDB-Environment" class="headerlink" title="4. DynamoDB Environment"></a>4. DynamoDB Environment</h1><p>This section presents how to create DynamoDB table and make sample data.<br>All operations are held in <code>CVM</code> instance.</p>
<h2 id="4-1-Create-DynamoDB-Table"><a href="#4-1-Create-DynamoDB-Table" class="headerlink" title="4.1 Create DynamoDB Table"></a>4.1 Create DynamoDB Table</h2><p>In command line, create an DynamoDB table  that uses the <code>aws dynamodb create-table</code> command as below.</p>
<pre><code>aws dynamodb create-table --table-name Tcaplus_test \
    --attribute-definitions AttributeName=Username,AttributeType=S \
    --key-schema AttributeName=Username,KeyType=HASH \
    --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5
</code></pre><h2 id="4-2-Verify-the-table-status"><a href="#4-2-Verify-the-table-status" class="headerlink" title="4.2 Verify the table status"></a>4.2 Verify the table status</h2><pre><code>aws dynamodb describe-table --table-name Tcaplus_test \
    --query &apos;Table.TableStatus&apos;
</code></pre><p>Check its response, <code>ACTIVE</code> means that table has been created successfully.</p>
<h2 id="4-3-Make-sample-data"><a href="#4-3-Make-sample-data" class="headerlink" title="4.3 Make sample data"></a>4.3 Make sample data</h2><p>Use <code>faker</code> module in Python to make sample data for DynamoDB, the code is as below:</p>
<pre><code>import argparse
import boto3
from faker import Faker
import json
import random
import sys

# write fake recrods to DynamoDB table to be used to demonstrate migration

genFake = Faker()

#dynamodb max batch size
MAXBATCHSIZE = 25

client = boto3.client(&apos;dynamodb&apos;, region_name=&apos;us-east-1&apos;)

def writeItems(recordCount,tableName):

  fullbatches = int(recordCount / MAXBATCHSIZE)
  partialbatch = recordCount % MAXBATCHSIZE

  for _ in range(fullbatches):
    try:
      response = client.batch_write_item(RequestItems={tableName: makeFakeBatch()})

      unprocessed_records = len(response[&apos;UnprocessedItems&apos;].get(tableName,[]))

      if unprocessed_records &gt; 0:
          print(&apos;Unprocessed Items: %d&apos; % len(response[&apos;UnprocessedItems&apos;].get(tableName,[])))

    except Exception as e:
      print(e)

  if partialbatch &gt;= 1:
    try:
      response = client.batch_write_item(RequestItems={tableName: makeFakeBatch(partialbatch)})

      unprocessed_records = len(response[&apos;UnprocessedItems&apos;].get(tableName,[]))

      if unprocessed_records &gt; 0:
          print(&apos;Unprocessed Items: %d&apos; % len(response[&apos;UnprocessedItems&apos;].get(tableName,[])))

    except Exception as e:
      print(e)

def makeFakeBatch(numrecords=MAXBATCHSIZE):
  fake_data = []
  for _ in range(numrecords):
    fake_record = {
      &quot;Username&quot;: {&quot;S&quot; : genFake.user_name()+str(random.randrange(0,10000))},
      &quot;Zipcode&quot;: {&quot;N&quot; : genFake.zipcode()},
      &quot;Subscribed&quot;: {&quot;BOOL&quot; : True},
      &quot;ReminderDate&quot;: {&quot;S&quot; : str(genFake.past_date())},
      &quot;PointsEarned&quot;: {&quot;N&quot; : str(genFake.random_int())},
      &quot;UserInfo&quot;: {&quot;S&quot;: genFake.text(1024)}
    }

    fake_data.append({&quot;PutRequest&quot;:{&quot;Item&quot;: fake_record}})

  return fake_data

def countRecords(tblName,scan_count=0,starting_key=None):

  if starting_key is None:
      response = client.scan(TableName=tblName, Select=&apos;COUNT&apos;, ConsistentRead=True)
  else:
      response = client.scan(TableName=tblName, ConsistentRead=True, Select=&apos;COUNT&apos;, ExclusiveStartKey=starting_key)

  if &apos;LastEvaluatedKey&apos; in response:
      scan_count += response[&apos;Count&apos;]
      return countRecords(tblName,scan_count,response[&apos;LastEvaluatedKey&apos;])
  else:
      scan_count += response[&apos;Count&apos;]
      return scan_count

def main(argv):
  parser = argparse.ArgumentParser()
  parser.add_argument(&quot;--items&quot;, help=&quot;number of items to create in table&quot;, default=25000, required=False)
  parser.add_argument(&quot;--table&quot;, help=&quot;name of table&quot;, default=&quot;Migration&quot;, required=False)
  args = parser.parse_args()

  recordCount = int(args.items)
  tableName = args.table

  writeItems(recordCount,tableName)

  print(&apos;Items in Table: %d&apos;% countRecords(tableName))
if __name__ == &quot;__main__&quot;:
  main(sys.argv[1:])
</code></pre><p>Execute the Python script in CVM as below.</p>
<pre><code>python make_sample_data.py --table Tcaplus_test --items 10000
</code></pre><h1 id="5-TcaplusDB-Environment"><a href="#5-TcaplusDB-Environment" class="headerlink" title="5. TcaplusDB Environment"></a>5. TcaplusDB Environment</h1><h2 id="5-1-Create-TcaplusDB-Table"><a href="#5-1-Create-TcaplusDB-Table" class="headerlink" title="5.1 Create TcaplusDB Table"></a>5.1 Create TcaplusDB Table</h2><p> In TencentCloud TcaplusDB Console, create an TcaplusDB table, see <a href="https://cloud.tencent.com/document/product/596/38808" target="_blank" rel="external">official website</a><br>TcaplusDB table protobuf (v3) file as below:</p>
<pre><code>syntax = &quot;proto3&quot;;
import &quot;tcaplusservice.optionv1.proto&quot;;
message Tcaplus_test {
    option(tcaplusservice.tcaplus_primary_key) = &quot;Username&quot;;

    string Username = 1;
    int64  PointsEarned = 2;
    string ReminderDate = 3;
    bool   Subscribed = 4;
    int64  Zipcode = 5;
    string UserInfo = 6;
}
</code></pre><h1 id="6-Migrate-Data-to-S3"><a href="#6-Migrate-Data-to-S3" class="headerlink" title="6. Migrate Data to S3"></a>6. Migrate Data to S3</h1><h2 id="6-1-Create-S3-Bucket"><a href="#6-1-Create-S3-Bucket" class="headerlink" title="6.1. Create S3 Bucket"></a>6.1. Create S3 Bucket</h2><p>Create an Amazon S3 bucket to receive the DynamoDB export.</p>
<pre><code>aws s3 mb s3://2-dynamodb-tcaplus-export
</code></pre><h2 id="6-2-Create-AWS-Data-Pipeline"><a href="#6-2-Create-AWS-Data-Pipeline" class="headerlink" title="6.2. Create AWS Data Pipeline"></a>6.2. Create AWS Data Pipeline</h2><p>Before you start, refer to <a href="https://docs.aws.amazon.com/datapipeline/latest/DeveloperGuide/dp-getting-started.html" target="_blank" rel="external">Getting Started with AWS Data Pipeline</a></p>
<ul>
<li>Source<ul>
<li>Select <code>Build using a template</code></li>
<li>Choose <code>Export DynamoDB table to S3</code></li>
</ul>
</li>
<li><p>Paramters</p>
<ul>
<li><code>Source DynamoDB table name</code>: Tcaplus_test</li>
<li><code>Output S3 folder</code>: s3://2-dynamodb-tcaplus-export/Tcaplus_test/</li>
<li><code>DynamoDB read throughput ratio</code>: 0.25</li>
<li><code>Region of the DynamoDB table</code>: us-east-1</li>
</ul>
</li>
<li><p>Schedule</p>
<ul>
<li>Select <code>on pipeline activation</code></li>
</ul>
</li>
<li>Pipeline Configuration<ul>
<li>Disable Logging , Enable it if necessary</li>
</ul>
</li>
<li>Security/Access<ul>
<li>IAM roles select <code>Default</code></li>
</ul>
</li>
</ul>
<h2 id="6-3-Migrate-S3-file-to-TencentCloud-COS"><a href="#6-3-Migrate-S3-file-to-TencentCloud-COS" class="headerlink" title="6.3. Migrate S3 file to TencentCloud COS"></a>6.3. Migrate S3 file to TencentCloud COS</h2><p>This section introduces two approaches to migrate S3 file to COS</p>
<ul>
<li>Command Line Mode</li>
<li>Programming Mode<h3 id="6-3-1-Command-Line-Mode"><a href="#6-3-1-Command-Line-Mode" class="headerlink" title="6.3.1 Command Line  Mode"></a>6.3.1 Command Line  Mode</h3></li>
<li>Step1, login the CVM instance with ssh</li>
<li>Step2, create a directory (<code>migration_tool</code>) under   <code>/root</code> directory</li>
<li>Step3, go into <code>migration_tool</code> directory and create a sub directory <code>tcaplus_test</code></li>
<li>Step4, download table file from s3 to local <code>tcaplus_test</code> directory<pre><code>  cd /root/migration_tool
  aws s3 cp s3://2-dynamodb-tcaplus-export/Tcaplus_test/2020-03-11-10-29-13 tcaplus_test/ --recursive
</code></pre></li>
<li>Step5, upload file from local directory to COS directory<pre><code>  cd /root/migration_tool
  coscmd -b tcaplus-sh-cos-1258272208 upload tcaplus_test Tcaplus_test/2020-03-11-10-29-13 -r
</code></pre><h3 id="6-3-2-Programming-Mode"><a href="#6-3-2-Programming-Mode" class="headerlink" title="6.3.2 Programming Mode"></a>6.3.2 Programming Mode</h3>Both S3 and COS provide Python SDK to operate objects, it&#x2019;s easy to write Python script.</li>
<li>Step1, login the CVM instance with ssh</li>
<li>Step2, install tencentcloud cos package with <code>pip install -U cos-python-sdk-v5</code> under Python3 Environment</li>
<li>Step2, create a directory (<code>migration_tool</code>) under   <code>/root</code> directory</li>
<li>Step3, go into <code>migration_tool</code> directory , create a Python Script named <code>s3_to_cos.py</code> as below:<br>```<br>#!/usr/bin/env python<h1 id="coding-utf-8"><a href="#coding-utf-8" class="headerlink" title="-*- coding=utf-8"></a>-*- coding=utf-8</h1>from qcloud_cos import CosConfig<br>from qcloud_cos import CosS3Client<br>import boto3<br>#table name of migration<br>dynamodb_table=&#x2019;Tcaplus_test&#x2019;<br>tcaplusdb_table=&#x2019;Tcaplus_test&#x2019;</li>
</ul>
<p>s3_bucket_name=&#x2019;2-dynamodb-tcaplus-export&#x2019;<br>cos_bucket_name = &#x2018;tcaplus-sh-cos-1258272208&#x2019;</p>
<p>s3_prefix=&#x201D;Tcaplus_test/2020-03-11-10-29-13&#x201D;<br>cos_prefix=&#x201D;Tcaplus_test/2020-03-11-10-29-13&#x201D;</p>
<p>#init S3 client<br>s3RegionName = &#x201C;us-east-1&#x201D;<br>s3Client = boto3.client(&#x201C;s3&#x201D;,region_name=s3RegionName)</p>
<p>scheme=&#x201D;https&#x201D;<br>cosRegionName=&#x201D;ap-shanghai&#x201D;</p>
<p>#replace your api credentials of your account<br>SECRET_ID=&#x2019;xxx&#x2019;<br>SECRET_KEY = &#x2018;xxx&#x2019;</p>
<p>#init cos client<br>cos_config = CosConfig(Region=cosRegionName, SecretId=SECRET_ID, SecretKey=SECRET_KEY,Scheme=scheme)<br>cosClient  = CosS3Client(cos_config)</p>
<p>def put_s3_to_cos():<br>    &#x201C;&#x201D;&#x201D;<br>    get s3 objects and put objects to cos<br>    :returns response<br>    &#x201C;&#x201D;&#x201D;<br>    try:</p>
<pre><code>    #list S3 objects of S3 bucket with prefix filter
    s3_resp  = s3Client.list_objects_v2(
        Bucket=s3_bucket_name,
        Prefix=s3_prefix,
        MaxKeys=1024
      )
    print(s3_resp)
    s3_objects = s3_resp[&apos;Contents&apos;]
    #iterate the object list , migrate one object each time
    #Note: if object size hits limit up (aws:5TB, tencent:5GB), you should use another interfaces ,see official website
    for s3_object in s3_objects:
       obj_content = s3Client.get_object(Bucket=s3_bucket_name,Key=s3_object[&apos;Key&apos;])
       obj_stream = obj_content[&apos;Body&apos;]
       cos_key =  s3_object[&apos;Key&apos;]
       cos_resp = cosClient.put_object(Bucket=cos_bucket_name,Body=obj_stream,Key=cos_key)
       print(cos_resp)
    print(&quot;s3 migrates to cos finish&quot;)
except Exception as e:
    print(&quot;s3 migrates to cos fail &quot;,e)
</code></pre><p>if <strong>name</strong> == &#x2018;<strong>main</strong>&#x2018;:<br>    put_s3_to_cos()</p>
<pre><code>## 6.4 Migrate COS Data to TcaplusDB
### 6.4.1 Prerequisites
* Prepare for TcaplusDB Python Restful SDK
Please refer to `TcaplusDB Essential` document. The SDK will be provided as attachment, and add this SDK to `/root/migrate_tool` directory.

* Download COS files from COS bucket to local directory of CVM
</code></pre><p>cd /root/migration_tool<br>coscmd -b tcaplus-sh-cos-1258272208 download Tcaplus_test/2020-03-11-10-29-13/ sample_data/ -r</p>
<pre><code>### 6.4.2 Data Type
The row format of COS file is low-level data type of DynamoDB. First, it must be converted to high level data.
* Low-level data
</code></pre><p>{&#x201C;a&#x201D;:{&#x201C;S&#x201D;:&#x201D;test&#x201D;}, &#x201C;b&#x201D;:{&#x201C;N&#x201D;:&#x201D;12&#x201D;}, &#x201C;c&#x201D;:{&#x201C;bOOL&#x201D;:true}}</p>
<pre><code>* High-level data
</code></pre><p>{ &#x201C;a&#x201D; : &#x201C;test&#x201D; ,  &#x201C;b&#x201D; : 12, &#x201C;c&#x201D; : True}</p>
<pre><code>### 6.4.3 Convert and Save
* Sample Data
</code></pre><p>{&#x201C;Username&#x201D;:{&#x201C;s&#x201D;:&#x201D;kevinortega9345&#x201D;},&#x201D;Subscribed&#x201D;:{&#x201C;bOOL&#x201D;:true},&#x201D;Zipcode&#x201D;:{&#x201C;n&#x201D;:&#x201D;86120&#x201D;},&#x201D;ReminderDate&#x201D;:{&#x201C;s&#x201D;:&#x201D;2020-02-07&#x201D;},&#x201D;PointsEarned&#x201D;:{&#x201C;n&#x201D;:&#x201D;4351&#x201D;} }<br>{&#x201C;Username&#x201D;:{&#x201C;s&#x201D;:&#x201D;ashleywilson3807&#x201D;},&#x201D;Subscribed&#x201D;:{&#x201C;bOOL&#x201D;:true},&#x201D;Zipcode&#x201D;:{&#x201C;n&#x201D;:&#x201D;20612&#x201D;},&#x201D;ReminderDate&#x201D;:{&#x201C;s&#x201D;:&#x201D;2020-03-02&#x201D;},&#x201D;PointsEarned&#x201D;:{&#x201C;n&#x201D;:&#x201D;4121&#x201D;}}<br>{&#x201C;Username&#x201D;:{&#x201C;s&#x201D;:&#x201D;frazierfrank8872&#x201D;},&#x201D;Subscribed&#x201D;:{&#x201C;bOOL&#x201D;:true},&#x201D;Zipcode&#x201D;:{&#x201C;n&#x201D;:&#x201D;9456&#x201D;},&#x201D;ReminderDate&#x201D;:{&#x201C;s&#x201D;:&#x201D;2020-02-17&#x201D;},&#x201D;PointsEarned&#x201D;:{&#x201C;n&#x201D;:&#x201D;7896&#x201D;}}<br>{&#x201C;Username&#x201D;:{&#x201C;s&#x201D;:&#x201D;eric383371&#x201D;},&#x201D;Subscribed&#x201D;:{&#x201C;bOOL&#x201D;:true},&#x201D;Zipcode&#x201D;:{&#x201C;n&#x201D;:&#x201D;7748&#x201D;},&#x201D;ReminderDate&#x201D;:{&#x201C;s&#x201D;:&#x201D;2020-02-25&#x201D;},&#x201D;PointsEarned&#x201D;:{&#x201C;n&#x201D;:&#x201D;6303&#x201D;}}</p>
<pre><code>* Convert and Save Script
Create a Python Script in  `/root/migration_tool` directory, the code is as below:
</code></pre><p>import json<br>import boto3<br>from tcaplus.tcaplusdb_rest_client import TcaplusRestClient</p>
<p>class CustomEncoder(json.JSONEncoder):<br>    def default(self, obj):<br>        try:<br>            if isinstance(obj, bytes):<br>                return str(obj, encoding=&#x2019;utf-8&#x2019;)<br>            elif isinstance(obj, decimal.Decimal):<br>                if obj == int(obj):<br>                    return int(obj)<br>                else:<br>                    return float(obj)<br>            elif isinstance(obj, set):<br>                return list(obj)</p>
<pre><code>        # Let the base class default method raise the TypeError
        return json.JSONEncoder.default(self, obj)
    except Exception as e:
        return obj.__dict__[&apos;value&apos;]
</code></pre><p>#dynamodb deserializer<br>boto3.resource(&#x201C;dynamodb&#x201D;)<br>deserializer = boto3.dynamodb.types.TypeDeserializer()</p>
<p>#TcaplusDB client</p>
<p>#TcaplusDB endpoint, internal ip address<br>endpoint=&#x201D;<a href="http://x.x.x.x" target="_blank" rel="external">http://x.x.x.x</a>&#x201C;</p>
<p>#TcaplusDB access id of table cluster<br>accessId = xxx</p>
<p>#TcaplusDB access password of table cluster<br>accessPasswd = &#x201C;xxxx&#x201D;</p>
<p>#TcaplusDB table groupo id<br>tableGroupId = xxx</p>
<p>#TcaplusDB table name<br>tableName = &#x201C;Tcaplus_test&#x201D;</p>
<p>#init TcaplusDB client<br>client = TcaplusRestClient(endpoint, accessId, accessPasswd)<br>client.SetTargetTable(tableGroupId, tableName)</p>
<p>def convert(filename):<br>    with open(filename) as f:<br>        lines = f.readlines()<br>        for line in lines:</p>
<pre><code>        #replace all irregular values
        nline = line.replace(&apos;:false&apos;,&apos;:&quot;False&quot;&apos;).replace(&apos;:true&apos;,&apos;:&quot;True&quot;&apos;).replace(&apos;bOOL&apos;,&apos;BOOL&apos;).replace(&apos;nULLValue&apos;,&apos;NULL&apos;)
        lowLevelLine = json.loads(nline)
        highLevelLine = {k: deserializer.deserialize(v) for k,v in lowLevelLine.items()}
        jsonStr = json.dumps(highLevelLine,cls=CustomEncoder)
        print(jsonStr)
        # add record to TcaplusDB
        record = json.loads(jsonStr)
        status, resp = client.AddRecord(record)
        print(resp)
</code></pre><p>if <strong>name</strong> == &#x2018;<strong>main</strong>&#x2018;:</p>
<pre><code>#replace your file name of sample data here
filename=os.getcwd()+&apos;/sample_data/c54a3412-44ba-4e69-b854-58050e133337&apos;
convert(filename)
</code></pre><pre><code>## 6.5. Summary
This section presents a simple way to migrate data from COS to TcaplusDB. However, if the data size is over 1GB or 10+GB, the performance will be unacceptable.
For big data scenarios,  parallelism is important. There are lots of big data suites such as Spark, Map/Reduce for this scenario. Here, the EMR product of TencentCloud is very suitable for processing data in parallel. Meanwhile, the EMR has gotten through COS, and user can use the EMR to process COS data directly. The whole steps will be introduced in next paper.
# 7. Attachment
* tcaplusdb-restapi-python-sdk-en
</code></pre><p><a href="https://git.code.oa.com/tcaplus/tcaplusdb-restapi-python-sdk-en" target="_blank" rel="external">https://git.code.oa.com/tcaplus/tcaplusdb-restapi-python-sdk-en</a><br>```<br>Include 8 basic API interfaces to operate TcaplusDB data</p>

    
    </div>
    
    
</article>





    
    
    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2020 Wen Qiuliang&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
                <br />
                <span id="busuanzi_container_site_uv">
	    	UV:
                <span id="busuanzi_value_site_uv">0</span>
		</span>
		<span id="busuanzi_container_site_pv">
	    	PV:
                <span id="busuanzi_value_site_pv">0</span>
		</span>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow has-text-black" title="GitHub" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
        </div>
    </div>
</footer>


    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("en-AU");
</script>


    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script>
    MathJax.Hub.Config({
        "HTML-CSS": {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
</script>

    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/js/jquery.justifiedGallery.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof($.fn.justifiedGallery) === 'function') {
                $('.justified-gallery').justifiedGallery();
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    


<script src="/js/script.js"></script>


    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js"></script>
    
</body>
</html>